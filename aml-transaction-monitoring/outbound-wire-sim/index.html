<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AML Sim: International Wire Transfers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Pinyon+Script&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .row-highlight { background-color: #fee2e2; border-left: 4px solid #ef4444; } /* Red for critical country risk */
        .row-normal { border-left: 4px solid transparent; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .btn-glow {
            animation: pulse-red 2s infinite;
            border-color: #ef4444 !important;
        }

        #cert-preview-container {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-md shrink-0 flex justify-between items-center z-20">
        <div class="flex items-center gap-4">
            <a href="../" class="group flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white rounded-md border border-slate-700 transition-all text-xs font-semibold uppercase tracking-wide">
                <i class="ph ph-arrow-u-up-left group-hover:-translate-x-1 transition-transform"></i>
                Hub
            </a>
            <div class="h-8 w-px bg-slate-700 hidden sm:block"></div>
            <div class="flex items-center gap-3">
                <div class="bg-red-600 p-2 rounded-lg">
                    <i class="ph ph-globe-hemisphere-east text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-wide">Scenario: Outbound International Wires</h1>
                    <a href="https://www.udemy.com/course/anti-money-laundering-aml-transaction-monitoring-analyst-training/?referralCode=405F72270A13A5D0E92C" 
                       target="_blank" 
                       class="text-[11px] text-red-300 hover:text-white underline block transition-colors mt-0.5">
                       Simulation part of AML, KYC and Transaction Monitoring Compliance Bootcamp ‚Üó
                    </a>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right hidden md:block">
                <div class="text-xs text-slate-400">High Risk Rule</div>
                <div class="font-mono font-bold text-red-400">Large Amt + FATF Country</div>
            </div>
            <div class="h-8 w-px bg-slate-700 hidden md:block"></div>
            <div class="text-right">
                <div class="text-xs text-slate-400">Sanctions Hit</div>
                <div id="score-display" class="font-bold text-xl">0 / 3</div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Nudge Modal -->
        <div id="nudge-modal" class="absolute inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm fade-in">
            <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full mx-4 border-t-4 border-red-500">
                <div class="flex items-start gap-3 mb-4">
                    <div class="bg-red-100 p-2 rounded-full text-red-600">
                        <i class="ph ph-warning-circle text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-slate-800">Review Incomplete</h3>
                        <p class="text-sm text-slate-600 mt-1">
                            You have identified <span id="nudge-count" class="font-bold">0</span> out of <span class="font-bold">3</span> high-risk transfers.
                        </p>
                    </div>
                </div>
                <p class="text-xs text-slate-500 mb-6 bg-slate-50 p-3 rounded">
                    <strong>Hint:</strong> Look for Country Codes <strong>MM</strong> (Myanmar), <strong>IR</strong> (Iran), and <strong>KP</strong> (North Korea). These are critical FATF/Sanctioned jurisdictions.
                </p>
                <div class="flex justify-end gap-3">
                    <button onclick="closeNudge()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded text-sm font-medium transition">
                        Resume Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="w-1/3 min-w-[340px] bg-white border-r border-slate-200 flex flex-col shadow-lg z-10 relative">
            <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <h2 class="font-bold text-slate-800 flex items-center gap-2">
                    <i class="ph ph-graduation-cap text-red-600"></i> 
                    Task Guidance
                </h2>
                <button onclick="resetSimulation()" class="text-xs text-slate-500 hover:text-red-600 flex items-center gap-1 transition">
                    <i class="ph ph-arrows-counter-clockwise"></i> Start Over
                </button>
            </div>
            
            <div id="narration-container" class="p-6 flex-1 overflow-y-auto space-y-6">
                <!-- Content injected via JS -->
            </div>

            <div class="p-4 border-t border-slate-200 bg-white flex justify-between items-center">
                <button onclick="prevScene()" id="btn-prev" class="px-4 py-2 text-slate-500 hover:text-slate-800 text-sm font-medium disabled:opacity-30" disabled>
                    <i class="ph ph-arrow-left"></i> Back
                </button>
                <div class="flex gap-1">
                    <span id="dot-1" class="w-2 h-2 rounded-full bg-red-600"></span>
                    <span id="dot-2" class="w-2 h-2 rounded-full bg-slate-300"></span>
                    <span id="dot-3" class="w-2 h-2 rounded-full bg-slate-300"></span>
                    <span id="dot-4" class="w-2 h-2 rounded-full bg-slate-300"></span>
                </div>
                <button onclick="attemptNextScene()" id="btn-next" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded shadow transition">
                    Next <i class="ph ph-arrow-right"></i>
                </button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="w-2/3 bg-slate-100 p-6 flex flex-col gap-6 overflow-hidden relative">
            
            <!-- Stats / Chart -->
            <div id="stats-panel" class="grid grid-cols-3 gap-4 shrink-0 transition-all duration-500">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 col-span-2">
                    <div class="text-xs text-slate-500 font-semibold uppercase mb-2">Global Reach (Destination Risk)</div>
                    <!-- Simple CSS Map Representation or Bar Chart of Countries -->
                    <div class="h-32 flex items-end justify-around border-b border-slate-200 pb-2 relative">
                        <div class="w-full h-full absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                            <i class="ph ph-globe text-9xl text-slate-300"></i>
                        </div>
                        <!-- Bars generated by JS -->
                        <canvas id="countryRiskChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex flex-col justify-center">
                    <div class="flex items-start gap-4">
                        <div class="p-3 bg-red-100 text-red-600 rounded-full">
                            <i class="ph ph-flag-banner text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800">Sanctions Check</h3>
                            <p class="text-xs text-slate-600 mt-1">
                                Wire transfers > $50k to <strong>FATF High-Risk</strong> jurisdictions require immediate escalation.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dataset -->
            <div id="dataset-panel" class="bg-white rounded-lg shadow-md border border-slate-200 flex-1 flex flex-col overflow-hidden transition-all duration-500">
                <!-- Toolbar -->
                <div class="p-3 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-sm text-slate-700 flex items-center gap-2">
                        <i class="ph ph-bank"></i> SWIFT Wire Log: April 2024
                    </h3>
                    <div class="flex gap-2">
                        <button id="filter-btn" onclick="toggleFilter()" class="flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-300 text-slate-600 rounded hover:bg-slate-50 text-sm transition shadow-sm relative">
                            <i class="ph ph-funnel"></i>
                            <span>Filter: > $50,000</span>
                        </button>
                    </div>
                </div>

                <!-- Table Header -->
                <div id="table-header" class="grid grid-cols-12 bg-slate-100 p-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200">
                    <div class="col-span-2">Date</div>
                    <div class="col-span-2">Tx ID</div>
                    <div class="col-span-2">Customer</div>
                    <div class="col-span-2">Dest. Country</div>
                    <div class="col-span-2 text-right pr-4">Amount (USD)</div>
                    <div class="col-span-2 text-center">Action</div>
                </div>

                <!-- Table Body -->
                <div id="transaction-table" class="overflow-y-auto flex-1 bg-white">
                    <!-- Rows injected by JS -->
                </div>
            </div>

            <!-- Case Log -->
            <div id="caselog-panel" class="h-48 bg-slate-800 rounded-lg shadow-inner flex flex-col shrink-0 text-white transition-all duration-500">
                <div class="p-3 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="font-bold text-sm flex items-center gap-2">
                        <i class="ph ph-file-text"></i> Case Log (Escalations)
                    </h3>
                    <span class="text-xs bg-slate-700 px-2 py-0.5 rounded text-slate-300">Requires Review</span>
                </div>
                <div class="overflow-y-auto p-0">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-400 uppercase bg-slate-800 sticky top-0">
                            <tr>
                                <th class="px-4 py-2">Case ID</th>
                                <th class="px-4 py-2">Customer</th>
                                <th class="px-4 py-2">Destination Risk</th>
                                <th class="px-4 py-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="case-log-body" class="text-slate-300">
                            <tr id="empty-log-msg">
                                <td colspan="4" class="px-4 py-8 text-center text-slate-500 italic">
                                    No high-risk wires flagged yet.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Certificate View -->
            <div id="certificate-view" class="hidden absolute inset-0 bg-slate-100 z-20 flex flex-col items-center justify-center p-6 fade-in">
                <div class="w-full max-w-4xl flex gap-6 h-full">
                    <div class="flex-1 flex flex-col justify-center items-center">
                        <h3 class="text-slate-500 text-xs uppercase font-bold mb-4 tracking-widest">Live Certificate Preview</h3>
                        <div id="cert-preview-container" class="relative bg-white p-1 rounded-lg border border-slate-200">
                             <canvas id="certCanvas" width="800" height="600" class="w-full h-auto max-h-[500px] shadow-sm"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script>
        (function() {
            // ==========================================
            // CONFIGURATION
            // ==========================================
            const COURSE_IMAGE_BASE64 = ""; 
            const UDEMY_LOGO_BASE64 = "";   

            const courseImgObj = new Image();
            const logoImgObj = new Image();
            if (COURSE_IMAGE_BASE64) courseImgObj.src = COURSE_IMAGE_BASE64;
            if (UDEMY_LOGO_BASE64) logoImgObj.src = UDEMY_LOGO_BASE64;

            // ==========================================
            // DATA (Based on provided CSV snippet)
            // ==========================================
            const transactions = [
                { id: 'OW001', cust: 'C20', date: '2024-04-01', amount: 20000, dest: 'US', risk: 'Low' },
                { id: 'OW002', cust: 'C21', date: '2024-04-02', amount: 55000, dest: 'MM', risk: 'High' }, // Alert: Myanmar (High Risk)
                { id: 'OW003', cust: 'C22', date: '2024-04-03', amount: 120000, dest: 'RU', risk: 'Medium' }, // Russia - Sanctioned but maybe not FATF blacklist in this specific scenario context or just "Watchlist". Script says ignored for this specific FATF rule. Let's follow script.
                { id: 'OW004', cust: 'C23', date: '2024-04-04', amount: 48000, dest: 'US', risk: 'Low' },
                { id: 'OW005', cust: 'C24', date: '2024-04-05', amount: 51000, dest: 'IR', risk: 'Critical' }, // Alert: Iran (Sanctioned)
                { id: 'OW006', cust: 'C25', date: '2024-04-06', amount: 75000, dest: 'AE', risk: 'Medium' }, // UAE - Grey list historically, but maybe not alerted here.
                { id: 'OW007', cust: 'C26', date: '2024-04-07', amount: 25000, dest: 'US', risk: 'Low' },
                { id: 'OW008', cust: 'C27', date: '2024-04-08', amount: 60000, dest: 'NG', risk: 'Medium' },
                { id: 'OW009', cust: 'C28', date: '2024-04-09', amount: 49500, dest: 'DE', risk: 'Low' },
                { id: 'OW010', cust: 'C29', date: '2024-04-10', amount: 80000, dest: 'KP', risk: 'Critical' }, // Alert: North Korea
                { id: 'OW011', cust: 'C30', date: '2024-04-11', amount: 10000, dest: 'US', risk: 'Low' },
                { id: 'OW012', cust: 'C31', date: '2024-04-12', amount: 150000, dest: 'FR', risk: 'Low' },
                { id: 'OW013', cust: 'C32', date: '2024-04-13', amount: 90000, dest: 'KY', risk: 'Medium' }, // Cayman - Tax haven risk, but maybe not FATF blacklist alert.
                { id: 'OW014', cust: 'C33', date: '2024-04-14', amount: 55000, dest: 'HK', risk: 'Low' },
                { id: 'OW015', cust: 'C34', date: '2024-04-15', amount: 200000, dest: 'KY', risk: 'Medium' } // Another Cayman
            ];

            // Target Alerts based on Script: C21 (MM), C24 (IR), C29 (KP)
            const TARGET_IDS = ['OW002', 'OW005', 'OW010'];

            // State
            let chartInstance = null;
            let currentScene = 0;
            let isFiltered = false;
            let loggedCases = new Set();
            let certName = "";

            const getScenes = () => [
                {
                    title: "1. Cross-Border Risks",
                    content: `
                        <div class="space-y-4 text-sm text-slate-600">
                            <p>Wire transfers are highly scrutinized. The risk isn't just the amount‚Äîit's the <strong>destination</strong>.</p>
                            <p>Our monitoring rule looks for: <strong>Large Amount</strong> (> $50k) AND <strong>High-Risk Jurisdiction</strong>.</p>
                            <div class="bg-red-50 border-l-4 border-red-500 p-3 text-red-800 text-xs">
                                <strong>FATF Targets:</strong> Myanmar (MM), Iran (IR), North Korea (KP).
                            </div>
                        </div>
                    `
                },
                {
                    title: "2. The Sanctions Landscape",
                    content: `
                        <div class="space-y-4 text-sm text-slate-600">
                            <p>Sending money to sanctioned countries like Iran or North Korea is a strict violation. Even "grey list" countries like Myanmar require enhanced due diligence (EDD).</p>
                            <p>Missing these can lead to massive regulatory fines.</p>
                        </div>
                    `
                },
                {
                    title: "3. Hands-On Task",
                    content: `
                        <div class="space-y-4 text-sm text-slate-600">
                            <p><strong>Your Mission:</strong> Block the bad wires.</p>
                            <ul class="list-disc ml-5 space-y-2">
                                <li><strong>Step 1:</strong> Use the <span class="text-red-600 font-bold">Filter</span> to see wires > $50,000.</li>
                                <li><strong>Step 2:</strong> Check the <strong>Dest. Country</strong> column.</li>
                                <li><strong>Step 3:</strong> Escalate wires to <strong>MM</strong>, <strong>IR</strong>, and <strong>KP</strong>. Ignore legitimate corridors (US, FR, DE).</li>
                            </ul>
                        </div>
                    `
                },
                {
                    title: "4. Certificate of Completion",
                    content: `
                        <div class="space-y-4 text-sm text-slate-600">
                            <p class="text-green-600 font-bold">üéâ Sanctions Enforced!</p>
                            <p>You correctly stopped transfers to high-risk jurisdictions. Enter your name to claim your badge.</p>
                            
                            <div class="bg-slate-50 p-4 rounded border border-slate-200 mt-4 shadow-sm">
                                <input type="text" id="cert-name-input" 
                                    oninput="updateCertificateName(this.value)"
                                    placeholder="Type Your Name Here..." 
                                    class="w-full p-2.5 text-base border border-slate-300 rounded mb-3 focus:ring-2 focus:ring-red-500 outline-none">
                                
                                <a id="download-link" href="#" onclick="downloadCertificate(this)" class="block w-full text-center bg-red-600 hover:bg-red-700 text-white py-2.5 rounded text-sm font-bold transition shadow-lg mt-2 flex items-center justify-center gap-2">
                                    <i class="ph ph-download-simple text-lg"></i> Download Certificate
                                </a>
                            </div>
                        </div>
                    `
                }
            ];

            let scenes = getScenes();

            // ==========================================
            // GLOBAL FUNCTIONS
            // ==========================================
            window.prevScene = function() {
                if(currentScene > 0) {
                    currentScene--;
                    renderNarration();
                }
            };

            window.attemptNextScene = function() {
                if (currentScene === 2) {
                    // Check if all targets found
                    const foundCount = TARGET_IDS.filter(id => loggedCases.has(id)).length;
                    
                    if (foundCount < 3) {
                        document.getElementById('nudge-count').innerText = foundCount;
                        document.getElementById('nudge-modal').classList.remove('hidden');
                        return;
                    }
                }
                if(currentScene < scenes.length - 1) {
                    currentScene++;
                    renderNarration();
                }
            };

            window.closeNudge = function() {
                document.getElementById('nudge-modal').classList.add('hidden');
            };

            window.toggleFilter = function() {
                isFiltered = !isFiltered;
                const btn = document.getElementById('filter-btn');
                
                if (isFiltered) {
                    btn.className = "flex items-center gap-2 px-3 py-1.5 bg-red-50 border border-red-300 text-red-700 rounded hover:bg-red-100 text-sm transition shadow-sm ring-2 ring-red-200 relative";
                    btn.innerHTML = `<i class="ph ph-funnel-x"></i> <span>Show All Wires</span>`;
                    if(currentScene < 2) {
                        currentScene = 2;
                        renderNarration();
                    }
                } else {
                    btn.className = "flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-300 text-slate-600 rounded hover:bg-slate-50 text-sm transition shadow-sm relative";
                    btn.innerHTML = `<i class="ph ph-funnel"></i> <span>Filter: > $50,000</span>`;
                }
                toggleGlowEffect();
                renderTable();
            };

            window.escalate = function(id) {
                if (loggedCases.has(id)) return;
                const tx = transactions.find(t => t.id === id);
                if (!tx) return;

                loggedCases.add(id);
                
                const tbody = document.getElementById('case-log-body');
                const emptyMsg = document.getElementById('empty-log-msg');
                if(emptyMsg) emptyMsg.remove();

                // Country Name Map
                const countryNames = { 'MM': 'Myanmar', 'IR': 'Iran', 'KP': 'North Korea', 'RU': 'Russia', 'AE': 'UAE', 'NG': 'Nigeria', 'KY': 'Cayman Is.' };
                const cName = countryNames[tx.dest] || tx.dest;

                const tr = document.createElement('tr');
                tr.className = "bg-slate-800 border-b border-slate-700 hover:bg-slate-750 transition fade-in";
                tr.innerHTML = `
                    <td class="px-4 py-2 font-mono text-red-300">CASE-${tx.id}</td>
                    <td class="px-4 py-2">${tx.cust}</td>
                    <td class="px-4 py-2 text-slate-300 text-xs">High Risk: ${cName}</td>
                    <td class="px-4 py-2"><span class="bg-red-900 text-red-200 px-2 py-0.5 rounded text-xs border border-red-700">Blocked</span></td>
                `;
                tbody.prepend(tr);

                // Score Logic
                const score = TARGET_IDS.filter(tid => loggedCases.has(tid)).length;
                document.getElementById('score-display').innerText = `${score} / 3`;
                
                renderTable();

                if (score === 3 && currentScene === 2) {
                    setTimeout(() => {
                        currentScene = 3;
                        renderNarration();
                    }, 1000);
                }
            };

            window.resetSimulation = function() {
                if(!confirm("Start Over?")) return;
                currentScene = 0;
                isFiltered = false;
                loggedCases.clear();
                certName = "";
                document.getElementById('score-display').innerText = "0 / 3";
                document.getElementById('case-log-body').innerHTML = `<tr id="empty-log-msg"><td colspan="4" class="px-4 py-8 text-center text-slate-500 italic">No high-risk wires flagged yet.</td></tr>`;
                
                initChart();
                renderTable();
                renderNarration();
            };

            window.updateCertificateName = function(val) {
                certName = val;
                drawCertificate(val);
            };

            window.downloadCertificate = function(el) {
                const canvas = document.getElementById('certCanvas');
                el.href = canvas.toDataURL("image/png");
                el.download = `AML_WireTransfer_Cert_${certName || 'Analyst'}.png`;
            };

            // ==========================================
            // HELPERS
            // ==========================================

            function initChart() {
                const ctx = document.getElementById('countryRiskChart').getContext('2d');
                
                // Group by Country Risk Level from our dataset
                // Low, Medium, High, Critical
                const counts = { 'Low': 0, 'Medium': 0, 'High': 0, 'Critical': 0 };
                transactions.forEach(t => {
                    if(counts[t.risk] !== undefined) counts[t.risk]++;
                });

                if(chartInstance) chartInstance.destroy();

                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Low Risk', 'Medium Risk', 'High Risk', 'Critical'],
                        datasets: [{
                            label: 'Tx Volume',
                            data: [counts['Low'], counts['Medium'], counts['High'], counts['Critical']],
                            backgroundColor: ['#cbd5e1', '#fcd34d', '#f87171', '#dc2626'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            function renderNarration() {
                const container = document.getElementById('narration-container');
                const scene = scenes[currentScene];
                container.innerHTML = `
                    <div class="fade-in">
                        <h3 class="font-bold text-lg text-slate-800 mb-2">${scene.title}</h3>
                        ${scene.content}
                    </div>
                `;
                
                for(let i=1; i<=4; i++) {
                    document.getElementById(`dot-${i}`).className = (i-1) === currentScene ? "w-2 h-2 rounded-full bg-red-600" : "w-2 h-2 rounded-full bg-slate-300";
                }

                document.getElementById('btn-prev').disabled = currentScene === 0;
                document.getElementById('btn-next').disabled = currentScene === scenes.length - 1;
                
                const filterBtn = document.getElementById('filter-btn');
                if(currentScene === 2 && !isFiltered) filterBtn.classList.add('btn-glow');
                else filterBtn.classList.remove('btn-glow');

                const certView = document.getElementById('certificate-view');
                const panels = ['stats-panel', 'dataset-panel', 'caselog-panel'].map(id => document.getElementById(id));
                
                if (currentScene === 3) {
                    panels.forEach(p => p.classList.add('hidden'));
                    certView.classList.remove('hidden');
                    drawCertificate(certName || ""); 
                } else {
                    panels.forEach(p => p.classList.remove('hidden'));
                    certView.classList.add('hidden');
                }
            }

            function toggleGlowEffect() {
                const btn = document.getElementById('filter-btn');
                if(currentScene === 2 && !isFiltered) btn.classList.add('btn-glow');
                else btn.classList.remove('btn-glow');
            }

            function renderTable() {
                const container = document.getElementById('transaction-table');
                container.innerHTML = '';

                transactions.forEach(tx => {
                    const isLogged = loggedCases.has(tx.id);
                    const isTarget = TARGET_IDS.includes(tx.id);
                    
                    // Filter Logic: If filtered, hide < 50k
                    if (isFiltered && tx.amount <= 50000) return;

                    let rowClass = "row-normal border-b border-slate-100 hover:bg-slate-50 transition";
                    if (isFiltered && isTarget) rowClass = "row-highlight border-b border-red-100";

                    const row = document.createElement('div');
                    row.className = `grid grid-cols-12 p-3 text-sm items-center ${rowClass}`;
                    
                    let actionHtml = '<span class="text-slate-400 text-xs">Cleared</span>';
                    
                    if (isLogged) {
                        actionHtml = `<span class="text-green-600 font-bold text-xs flex items-center justify-center gap-1"><i class="ph ph-check-circle"></i> Logged</span>`;
                    } else if (isTarget && isFiltered) {
                        actionHtml = `<button onclick="escalate('${tx.id}')" class="bg-red-600 hover:bg-red-700 text-white text-xs px-3 py-1.5 rounded shadow flex items-center gap-1 mx-auto transition transform active:scale-95"><i class="ph ph-warning"></i> Escalate</button>`;
                    } else if (isFiltered) {
                        // High value but safe country (e.g. US, FR)
                        actionHtml = `<span class="text-slate-400 text-xs italic">Low Risk</span>`;
                    }

                    // Flag Icon
                    let flag = 'üè≥Ô∏è';
                    const flags = { 'US': 'üá∫üá∏', 'MM': 'üá≤üá≤', 'RU': 'üá∑üá∫', 'IR': 'üáÆüá∑', 'AE': 'üá¶üá™', 'NG': 'üá≥üá¨', 'DE': 'üá©üá™', 'KP': 'üá∞üáµ', 'FR': 'üá´üá∑', 'KY': 'üá∞üáæ', 'HK': 'üá≠üá∞' };
                    if(flags[tx.dest]) flag = flags[tx.dest];

                    row.innerHTML = `
                        <div class="col-span-2 font-mono text-slate-600">${tx.date}</div>
                        <div class="col-span-2 text-slate-500">${tx.id}</div>
                        <div class="col-span-2 font-medium text-slate-700">${tx.cust}</div>
                        <div class="col-span-2 font-bold ${isTarget && isFiltered ? 'text-red-600' : 'text-slate-700'}">${flag} ${tx.dest}</div>
                        <div class="col-span-2 text-right pr-4 font-mono ${isTarget && isFiltered ? 'text-red-700 font-bold' : 'text-slate-600'}">$${tx.amount.toLocaleString()}</div>
                        <div class="col-span-2 text-center">${actionHtml}</div>
                    `;
                    container.appendChild(row);
                });
            }

            function drawCertificate(name) {
                const canvas = document.getElementById('certCanvas');
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, 800, 600);
                
                ctx.strokeStyle = "#dc2626"; // Red 600
                ctx.lineWidth = 15;
                ctx.strokeRect(20, 20, 760, 560);
                ctx.strokeStyle = "#1e293b"; 
                ctx.lineWidth = 4;
                ctx.strokeRect(35, 35, 730, 530);

                ctx.fillStyle = "#1e293b"; 
                ctx.textAlign = "left";
                ctx.font = "bold 24px 'Cinzel', serif";
                ctx.fillText("AML, KYC & Transaction", 60, 80);
                ctx.fillText("Monitoring Compliance Bootcamp", 60, 110);

                if (UDEMY_LOGO_BASE64 && logoImgObj.complete) {
                     const aspect = logoImgObj.width / logoImgObj.height;
                     ctx.drawImage(logoImgObj, 730 - (50*aspect), 65, 50*aspect, 50);
                } else {
                    ctx.fillStyle = "#a435f0"; 
                    ctx.beginPath();
                    ctx.arc(705, 90, 25, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = "white";
                    ctx.font = "bold 20px sans-serif";
                    ctx.textAlign = "center";
                    ctx.fillText("U", 705, 97);
                }

                ctx.textAlign = "center";
                ctx.fillStyle = "#dc2626"; 
                ctx.font = "bold 40px 'Cinzel', serif";
                ctx.fillText("Sanctions Enforced!", 400, 200);

                ctx.fillStyle = "#475569"; 
                ctx.font = "18px 'Inter', sans-serif";
                ctx.fillText("You successfully blocked high-risk wire transfers:", 400, 240);

                ctx.fillStyle = "#1e293b"; 
                ctx.font = "bold 28px 'Inter', sans-serif";
                ctx.fillText("International Wire Scenario", 400, 280);

                const display = name || "Analyst Name";
                ctx.font = "italic bold 50px 'Pinyon Script', cursive";
                ctx.fillStyle = "#dc2626"; 
                ctx.fillText(display, 400, 360);
                
                ctx.beginPath();
                ctx.moveTo(250, 370);
                ctx.lineTo(550, 370);
                ctx.strokeStyle = "#cbd5e1"; 
                ctx.lineWidth = 2;
                ctx.stroke();

                if (COURSE_IMAGE_BASE64 && courseImgObj.complete) {
                     ctx.drawImage(courseImgObj, 60, 440, 120, 80);
                } else {
                    ctx.fillStyle = "#dc2626";
                    ctx.fillRect(60, 440, 120, 80);
                    ctx.fillStyle = "white";
                    ctx.font = "bold 12px sans-serif";
                    ctx.textAlign = "center";
                    ctx.fillText("AML SIM", 120, 485);
                }

                ctx.textAlign = "left";
                ctx.fillStyle = "#334155";
                ctx.font = "bold 16px 'Inter', sans-serif";
                ctx.fillText("Course: AML, KYC & Transaction Monitoring Compliance Bootcamp", 200, 470);
                ctx.fillText("Instructor: Sudeep Suresh", 200, 500);

                ctx.fillStyle = "#94a3b8";
                ctx.font = "12px 'Inter', sans-serif";
                ctx.textAlign = "center";
                ctx.fillText("This badge certifies mastery of sanctions screening.", 400, 560);
            }

            window.addEventListener('load', () => {
                initChart();
                renderNarration();
                renderTable();
            });
        })();
    </script>
</body>
</html>
